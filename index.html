<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Summarizer</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2rem; max-width: 800px; }
        input, button { margin: 0.25rem 0; padding: 0.5rem; width: 100%; }
        #summary { white-space: pre-wrap; margin-top: 1rem; }
        .api { margin-top: 1rem; }
    </style>
</head>
<body>
    <h1>YouTube Video Summarizer</h1>
    <p>Enter a YouTube URL and (on first use) your OpenAI API key to summarize the video transcript. The key is stored securely in your browser and can be reset at any time.</p>
    <input type="text" id="url" placeholder="YouTube URL">
    <input type="text" id="apiKey" class="api" placeholder="OpenAI API Key">
    <button id="resetKey" class="api" style="display:none;">Reset API Key</button>
    <button id="summarize">Summarize</button>
    <div id="status"></div>
    <h2>Summary</h2>
    <div id="summary"></div>

    <script>
    function parseVideoId(url) {
        try {
            const u = new URL(url);
            if (u.hostname.includes('youtu.be')) {
                return u.pathname.slice(1);
            }
            if (u.hostname.includes('youtube.com')) {
                return u.searchParams.get('v');
            }
        } catch (e) {}
        return null;
    }

    async function fetchTranscript(videoId) {
        const res = await fetch(`https://youtubetranscript.com/?server_vid2=${videoId}`);
        if (!res.ok) throw new Error('Transcript not available');
        const data = await res.json();
        return data.map(d => d.text).join(' ');
    }

    async function summarize(text, apiKey) {
        const promptRes = await fetch('prompt.md');
        if (!promptRes.ok) throw new Error('Prompt not found');
        const prompt = await promptRes.text();
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: 'gpt-5-mini',
                messages: [
                    { role: 'system', content: prompt },
                    { role: 'user', content: text }
                ]
            })
        });
        if (!res.ok) {
            const err = await res.text();
            throw new Error(err);
        }
        const json = await res.json();
        return json.choices[0].message.content.trim();
    }

    const DB_NAME = 'yousum-config';
    const STORE_NAME = 'keys';

    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, 1);
            request.onupgradeneeded = () => request.result.createObjectStore(STORE_NAME);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    }

    async function getCryptoKey() {
        const db = await openDB();
        return new Promise((resolve, reject) => {
            const tx = db.transaction(STORE_NAME, 'readonly');
            const store = tx.objectStore(STORE_NAME);
            const req = store.get('api');
            req.onsuccess = async () => {
                let key = req.result;
                if (!key) {
                    key = await crypto.subtle.generateKey(
                        { name: 'AES-GCM', length: 256 },
                        false,
                        ['encrypt', 'decrypt']
                    );
                    const txw = db.transaction(STORE_NAME, 'readwrite');
                    txw.objectStore(STORE_NAME).put(key, 'api');
                    txw.oncomplete = () => resolve(key);
                    txw.onerror = () => reject(txw.error);
                } else {
                    resolve(key);
                }
            };
            req.onerror = () => reject(req.error);
        });
    }

    async function saveApiKey(apiKey) {
        const key = await getCryptoKey();
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const encoded = new TextEncoder().encode(apiKey);
        const ciphertext = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, encoded);
        const payload = { iv: Array.from(iv), data: Array.from(new Uint8Array(ciphertext)) };
        localStorage.setItem('apiKey', JSON.stringify(payload));
    }

    async function loadApiKey() {
        const stored = localStorage.getItem('apiKey');
        if (!stored) return '';
        const key = await getCryptoKey();
        const { iv, data } = JSON.parse(stored);
        const ciphertext = new Uint8Array(data);
        const buffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: new Uint8Array(iv) }, key, ciphertext);
        return new TextDecoder().decode(buffer);
    }

    document.addEventListener('DOMContentLoaded', async () => {
        const apiInput = document.getElementById('apiKey');
        const resetBtn = document.getElementById('resetKey');
        const status = document.getElementById('status');
        const saved = await loadApiKey();
        if (saved) {
            apiInput.value = saved;
            apiInput.style.display = 'none';
            resetBtn.style.display = 'block';
            status.textContent = 'Using stored API key.';
        }
        resetBtn.addEventListener('click', async () => {
            localStorage.removeItem('apiKey');
            const db = await openDB();
            const tx = db.transaction(STORE_NAME, 'readwrite');
            tx.objectStore(STORE_NAME).delete('api');
            tx.oncomplete = () => {
                apiInput.value = '';
                apiInput.style.display = 'block';
                resetBtn.style.display = 'none';
                status.textContent = 'API key cleared. Enter a new key.';
            };
        });
    });

    document.getElementById('summarize').addEventListener('click', async () => {
        const url = document.getElementById('url').value;
        const apiInput = document.getElementById('apiKey');
        const resetBtn = document.getElementById('resetKey');
        const apiKey = apiInput.value;
        await saveApiKey(apiKey);
        apiInput.style.display = 'none';
        resetBtn.style.display = 'block';
        const status = document.getElementById('status');
        const summaryEl = document.getElementById('summary');
        summaryEl.textContent = '';
        try {
            status.textContent = 'Fetching transcript...';
            const videoId = parseVideoId(url);
            if (!videoId) throw new Error('Invalid URL');
            const transcript = await fetchTranscript(videoId);
            status.textContent = 'Summarizing...';
            const summary = await summarize(transcript, apiKey);
            summaryEl.textContent = summary;
            status.textContent = 'Done.';
        } catch (e) {
            status.textContent = 'Error: ' + e.message;
        }
    });
    </script>
</body>
</html>
